<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Secure Storage Demo v2</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  body { background-color: #f8f9fa; }
  .card { margin-bottom: 20px; }
  #storageTable td { font-family: monospace; font-size: 0.85rem; }
  #logPanel { max-height: 150px; overflow-y: auto; background: #212529; color: #f8f9fa; padding: 10px; border-radius: 5px; font-size: 0.85rem; }
</style>
</head>
<body class="container py-4">
<h1 class="mb-4">üîê Secure Client-Side Storage Demo</h1>

<!-- Init -->
<div class="card">
  <div class="card-header">Step 1: Initialize Wrapper</div>
  <div class="card-body">
    <div class="mb-3">
      <label class="form-label">Session Passphrase</label>
      <input id="passphrase" class="form-control" value="session-secret-demo">
    </div>
    <button class="btn btn-primary" onclick="initStorage()">Initialize</button>
  </div>
</div>

<!-- Save -->
<div class="card">
  <div class="card-header">Step 2: Save Encrypted Secret</div>
  <div class="card-body">
    <div class="row g-2">
      <div class="col-md-4"><input id="key" class="form-control" placeholder="Key (e.g., token)"></div>
      <div class="col-md-4"><input id="value" class="form-control" placeholder="Value (e.g., abc123)"></div>
      <div class="col-md-3"><input id="expiry" type="number" class="form-control" placeholder="Expiry (sec)" value="60"></div>
      <div class="col-md-1 d-grid"><button class="btn btn-success" onclick="saveItem()">Save</button></div>
    </div>
  </div>
</div>

<!-- Read -->
<div class="card">
  <div class="card-header">Step 3: Read Secret</div>
  <div class="card-body">
    <div class="input-group">
      <input id="readKey" class="form-control" placeholder="Key to read">
      <button class="btn btn-primary" onclick="readItem()">Read</button>
      <button class="btn btn-warning" onclick="simulateExpiry()">Simulate Expiry</button>
    </div>
    <div class="mt-3">
      <strong>Decrypted Value:</strong> <span id="output" class="text-success"></span>
    </div>
  </div>
</div>

<!-- Storage Preview -->
<div class="card">
  <div class="card-header">Storage Preview (Ciphertext Only)</div>
  <div class="card-body">
    <table class="table table-sm table-bordered" id="storageTable">
      <thead class="table-light"><tr><th>Key</th><th>Stored JSON (truncated)</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- Logs -->
<div class="card">
  <div class="card-header">Activity Log</div>
  <div class="card-body"><div id="logPanel"></div></div>
</div>

<script type="module">
import SecureStorage from './secureStorage.js';
let initialized = false;

function log(msg) {
  const panel = document.getElementById('logPanel');
  const line = document.createElement('div');
  line.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
  panel.appendChild(line);
  panel.scrollTop = panel.scrollHeight;
}

window.initStorage = async function() {
  const passphrase = document.getElementById('passphrase').value;
  await SecureStorage.init({ passphrase });
  initialized = true;
  log("SecureStorage initialized.");
  refreshTable();
};

window.saveItem = async function() {
  if (!initialized) return log("Initialize first!");
  const key = document.getElementById('key').value;
  const val = document.getElementById('value').value;
  const expiry = parseInt(document.getElementById('expiry').value);
  await SecureStorage.setItem(key, val, expiry);
  log(`Saved item: ${key} (expires in ${expiry}s)`);
  refreshTable();
};

window.readItem = async function() {
  if (!initialized) return log("Initialize first!");
  const key = document.getElementById('readKey').value;
  const val = await SecureStorage.getItem(key);
  if (val === null) {
    log(`Item ${key} not found or expired.`);
    document.getElementById('output').textContent = '';
  } else {
    log(`Read item: ${key} ‚Üí ${val}`);
    document.getElementById('output').textContent = val;
  }
  refreshTable();
};

window.simulateExpiry = function() {
  if (!initialized) return log("Initialize first!");
  const key = document.getElementById('readKey').value;
  const raw = localStorage.getItem("ssw_v2::" + key);
  if (raw) {
    const data = JSON.parse(raw);
    data.expiry = Date.now() - 1000;
    localStorage.setItem("ssw_v2::" + key, JSON.stringify(data));
    log(`Simulated expiry for key ${key}.`);
  }
  refreshTable();
};

function refreshTable() {
  const tbody = document.querySelector("#storageTable tbody");
  tbody.innerHTML = '';
  for (let i = 0; i < localStorage.length; i++) {
    const k = localStorage.key(i);
    if (k.startsWith("ssw_v2::") && k !== "ssw_v2::salt") {
      const v = localStorage.getItem(k);
      const tr = document.createElement("tr");
      const td1 = document.createElement("td"); td1.textContent = k;
      const td2 = document.createElement("td"); td2.textContent = v.slice(0, 80) + (v.length > 80 ? "..." : "");
      tr.appendChild(td1); tr.appendChild(td2);
      tbody.appendChild(tr);
    }
  }
}
</script>
</body>
</html>
